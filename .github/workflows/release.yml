name: Release
# Triggers on version tags (v*) to build and publish macOS releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Test build without creating release'
        required: false
        default: false
        type: boolean

jobs:
  build-macos-intel:
    runs-on: macos-15-intel
    outputs:
      notarization_id: ${{ steps.notarize.outputs.notarization-id }}
      dmg_file: ${{ steps.notarize.outputs.dmg-file }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Setup Node.js and install dependencies
        uses: ./.github/actions/setup-node-frontend

      - name: Install Rust toolchain (for building native Python packages)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache pip wheel cache (for compiled packages like real_ladybug)
        uses: actions/cache@v5
        with:
          path: ~/Library/Caches/pip
          key: pip-wheel-${{ runner.os }}-x64-${{ hashFiles('apps/backend/requirements.txt') }}
          restore-keys: |
            pip-wheel-${{ runner.os }}-x64-

      - name: Cache bundled Python
        uses: actions/cache@v5
        with:
          path: apps/frontend/python-runtime
          key: python-bundle-${{ runner.os }}-x64-3.12.8-rust-${{ hashFiles('apps/backend/requirements.txt') }}
          restore-keys: |
            python-bundle-${{ runner.os }}-x64-3.12.8-rust-

      - name: Build application
        run: npm --workspace apps/frontend run build
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_TRACES_SAMPLE_RATE: ${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}
          SENTRY_PROFILES_SAMPLE_RATE: ${{ secrets.SENTRY_PROFILES_SAMPLE_RATE }}

      - name: Configure macOS code signing (optional)
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          if [ -n "$MACOS_CERTIFICATE_P12_BASE64" ] && [ -n "$MACOS_CERTIFICATE_PASSWORD" ]; then
            CERT_PATH="$RUNNER_TEMP/macos-signing.p12"
            echo "$MACOS_CERTIFICATE_P12_BASE64" | base64 --decode > "$CERT_PATH"
            echo "CSC_LINK=$CERT_PATH" >> "$GITHUB_ENV"
            echo "CSC_KEY_PASSWORD=$MACOS_CERTIFICATE_PASSWORD" >> "$GITHUB_ENV"
            echo "CSC_NAME=Frank Cottone (W778837A9L)" >> "$GITHUB_ENV"
            echo "CSC_IDENTITY_AUTO_DISCOVERY=true" >> "$GITHUB_ENV"
            echo "MACOS_SIGNING_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "macOS signing certificate configured for electron-builder."
          else
            echo "::warning::MACOS_CERTIFICATE_P12_BASE64 / MACOS_CERTIFICATE_PASSWORD not set; building unsigned macOS artifacts. Auto-update install will fail on macOS for unsigned apps."
            echo "CSC_IDENTITY_AUTO_DISCOVERY=false" >> "$GITHUB_ENV"
            echo "MACOS_SIGNING_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

      - name: Package macOS (Intel)
        run: npm --workspace apps/frontend run package:mac -- --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_TRACES_SAMPLE_RATE: ${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}
          SENTRY_PROFILES_SAMPLE_RATE: ${{ secrets.SENTRY_PROFILES_SAMPLE_RATE }}

      - name: Submit notarization (async)
        id: notarize
        if: env.MACOS_SIGNING_AVAILABLE == 'true'
        uses: ./.github/actions/submit-macos-notarization
        with:
          apple-id: ${{ secrets.APPLE_ID }}
          apple-app-specific-password: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          apple-team-id: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-builds
          path: |
            apps/frontend/dist/*.dmg
            apps/frontend/dist/*.zip
            apps/frontend/dist/*.yml
            apps/frontend/dist/*.blockmap

  build-macos-arm64:
    runs-on: macos-15
    outputs:
      notarization_id: ${{ steps.notarize.outputs.notarization-id }}
      dmg_file: ${{ steps.notarize.outputs.dmg-file }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Setup Node.js and install dependencies
        uses: ./.github/actions/setup-node-frontend

      - name: Cache pip wheel cache
        uses: actions/cache@v5
        with:
          path: ~/Library/Caches/pip
          key: pip-wheel-${{ runner.os }}-arm64-${{ hashFiles('apps/backend/requirements.txt') }}
          restore-keys: |
            pip-wheel-${{ runner.os }}-arm64-

      - name: Cache bundled Python
        uses: actions/cache@v5
        with:
          path: apps/frontend/python-runtime
          key: python-bundle-${{ runner.os }}-arm64-3.12.8-${{ hashFiles('apps/backend/requirements.txt') }}
          restore-keys: |
            python-bundle-${{ runner.os }}-arm64-3.12.8-

      - name: Build application
        run: npm --workspace apps/frontend run build
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_TRACES_SAMPLE_RATE: ${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}
          SENTRY_PROFILES_SAMPLE_RATE: ${{ secrets.SENTRY_PROFILES_SAMPLE_RATE }}

      - name: Configure macOS code signing (optional)
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          if [ -n "$MACOS_CERTIFICATE_P12_BASE64" ] && [ -n "$MACOS_CERTIFICATE_PASSWORD" ]; then
            CERT_PATH="$RUNNER_TEMP/macos-signing.p12"
            echo "$MACOS_CERTIFICATE_P12_BASE64" | base64 --decode > "$CERT_PATH"
            echo "CSC_LINK=$CERT_PATH" >> "$GITHUB_ENV"
            echo "CSC_KEY_PASSWORD=$MACOS_CERTIFICATE_PASSWORD" >> "$GITHUB_ENV"
            echo "CSC_NAME=Frank Cottone (W778837A9L)" >> "$GITHUB_ENV"
            echo "CSC_IDENTITY_AUTO_DISCOVERY=true" >> "$GITHUB_ENV"
            echo "MACOS_SIGNING_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "macOS signing certificate configured for electron-builder."
          else
            echo "::warning::MACOS_CERTIFICATE_P12_BASE64 / MACOS_CERTIFICATE_PASSWORD not set; building unsigned macOS artifacts. Auto-update install will fail on macOS for unsigned apps."
            echo "CSC_IDENTITY_AUTO_DISCOVERY=false" >> "$GITHUB_ENV"
            echo "MACOS_SIGNING_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

      - name: Package macOS (Apple Silicon)
        run: npm --workspace apps/frontend run package:mac -- --arm64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_TRACES_SAMPLE_RATE: ${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}
          SENTRY_PROFILES_SAMPLE_RATE: ${{ secrets.SENTRY_PROFILES_SAMPLE_RATE }}

      - name: Submit notarization (async)
        id: notarize
        if: env.MACOS_SIGNING_AVAILABLE == 'true'
        uses: ./.github/actions/submit-macos-notarization
        with:
          apple-id: ${{ secrets.APPLE_ID }}
          apple-app-specific-password: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          apple-team-id: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-builds
          path: |
            apps/frontend/dist/*.dmg
            apps/frontend/dist/*.zip
            apps/frontend/dist/*.yml
            apps/frontend/dist/*.blockmap

  finalize-notarization:
    needs: [build-macos-intel, build-macos-arm64]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Intel DMG
        uses: actions/download-artifact@v7
        with:
          name: macos-intel-builds
          path: intel

      - name: Download ARM64 DMG
        uses: actions/download-artifact@v7
        with:
          name: macos-arm64-builds
          path: arm64

      - name: Wait for notarization and staple
        uses: ./.github/actions/finalize-macos-notarization
        with:
          apple-id: ${{ secrets.APPLE_ID }}
          apple-app-specific-password: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          apple-team-id: ${{ secrets.APPLE_TEAM_ID }}
          intel-notarization-id: ${{ needs.build-macos-intel.outputs.notarization_id }}
          arm64-notarization-id: ${{ needs.build-macos-arm64.outputs.notarization_id }}
          intel-dmg-file: ${{ needs.build-macos-intel.outputs.dmg_file }}
          arm64-dmg-file: ${{ needs.build-macos-arm64.outputs.dmg_file }}

      - name: Upload stapled Intel DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-stapled
          path: intel/*.dmg

      - name: Upload stapled ARM64 DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-stapled
          path: arm64/*.dmg

  create-release:
    needs: [build-macos-intel, build-macos-arm64, finalize-notarization]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist

      - name: Flatten binary artifacts
        run: |
          mkdir -p release-assets

          # Use stapled DMGs if available, fall back to un-stapled
          if find dist/macos-intel-stapled dist/macos-arm64-stapled -type f -name "*.dmg" 2>/dev/null | grep -q .; then
            find dist/macos-intel-stapled dist/macos-arm64-stapled -type f -name "*.dmg" -exec cp {} release-assets/ \;
          else
            echo "::warning::No stapled DMGs found. Using un-stapled DMGs."
            find dist/macos-intel-builds dist/macos-arm64-builds -type f -name "*.dmg" -exec cp {} release-assets/ \; 2>/dev/null || true
          fi

          # Copy other macOS artifacts (zip, yml, blockmap)
          find dist/macos-intel-builds dist/macos-arm64-builds -type f \
            \( -name "*.zip" -o -name "*.yml" -o -name "*.blockmap" \) \
            -exec cp {} release-assets/ \; 2>/dev/null || true

          installer_count=$(find release-assets -type f \( -name "*.dmg" -o -name "*.zip" \) | wc -l)
          if [ "$installer_count" -eq 0 ]; then
            echo "::error::No macOS installer artifacts found!"
            exit 1
          fi
          echo "Found $installer_count macOS artifact(s):"
          find release-assets -type f \( -name "*.dmg" -o -name "*.zip" \) -exec basename {} \;

      - name: Merge macOS manifests
        uses: ./.github/actions/merge-macos-manifests
        with:
          dist-path: dist
          output-path: release-assets
          copy-other-manifests: 'true'

      - name: Validate manifests
        run: |
          if [ ! -f "release-assets/latest-mac.yml" ]; then
            echo "::error::latest-mac.yml not found! Auto-update will not work."
            exit 1
          fi
          echo "Manifests present:"
          find release-assets -name "*.yml" -exec basename {} \;
          echo ""
          echo "All release assets:"
          ls -la release-assets/

      - name: Generate checksums
        run: |
          cd release-assets
          sha256sum ./* > checksums.sha256
          cat checksums.sha256

      - name: Dry run summary
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == true }}
        run: |
          echo "## Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts created successfully:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la release-assets/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Extract changelog from CHANGELOG.md
        if: ${{ github.event_name == 'push' }}
        id: changelog
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          CHANGELOG_FILE="CHANGELOG.md"
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "body=Release v$VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi
          CHANGELOG_CONTENT=$(awk -v ver="$VERSION" '
            BEGIN { found=0; content="" }
            /^## / {
              if (found) exit
              if ($2 == ver || $2 ~ "^"ver"[[:space:]]*-") { found=1; next }
            }
            /^---$/ { if (found) exit }
            found { content = content $0 "\n" }
            END {
              if (!found) { print "NOT_FOUND"; exit 0 }
              gsub(/^[[:space:]]+|[[:space:]]+$/, "", content)
              print content
            }
          ' "$CHANGELOG_FILE")
          if [ "$CHANGELOG_CONTENT" = "NOT_FOUND" ] || [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="Release v$VERSION"
          fi
          echo "$CHANGELOG_CONTENT" > changelog-body.md
          { echo "body<<CHANGELOG_EOF"; cat changelog-body.md; echo "CHANGELOG_EOF"; } >> $GITHUB_OUTPUT

      - name: Create Release
        if: ${{ github.event_name == 'push' }}
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ${{ steps.changelog.outputs.body }}

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md
          files: release-assets/*
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'bmad') }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

repos:
  # Version sync - propagate root package.json version to all files
  # NOTE: Skip in worktrees - version sync modifies root files which don't exist in worktree
  - repo: local
    hooks:
      - id: version-sync
        name: Version Sync
        entry: bash
        args:
          - -c
          - |
            # Skip in worktrees - .git is a file pointing to main repo, not a directory
            # Version sync modifies root-level files that may not exist in worktree context
            if [ -f ".git" ]; then
              echo "Skipping version-sync in worktree (root files not accessible)"
              exit 0
            fi
            VERSION=$(node -p "require('./package.json').version")
            if [ -n "$VERSION" ]; then

              # Sync to apps/desktop/package.json
              node -e "
                const fs = require('fs');
                const p = require('./apps/desktop/package.json');
                const v = process.argv[1];
                if (p.version !== v) {
                  p.version = v;
                  fs.writeFileSync('./apps/desktop/package.json', JSON.stringify(p, null, 2) + '\n');
                }
              " "$VERSION"

              # Sync to README.md - section-aware updates (stable vs beta)
              ESCAPED_VERSION=$(echo "$VERSION" | sed 's/-/--/g')

              # Detect if this is a prerelease (contains - after base version)
              if echo "$VERSION" | grep -q '-'; then
                # PRERELEASE: Update only beta sections
                echo "  Detected PRERELEASE version: $VERSION"

                # Update beta version badge (orange)
                sed -i.bak "s/beta-[0-9]*\.[0-9]*\.[0-9]*\(--[a-z]*\.[0-9]*\)*-orange/beta-$ESCAPED_VERSION-orange/g" README.md

                # Update beta version badge link
                sed -i.bak '/<!-- BETA_VERSION_BADGE -->/,/<!-- BETA_VERSION_BADGE_END -->/s|releases/tag/v[0-9.a-z-]*)|releases/tag/v'"$VERSION"')|g' README.md

                # Update beta download links (within BETA_DOWNLOADS section only)
                for SUFFIX in "win32-x64.exe" "darwin-arm64.dmg" "darwin-x64.dmg" "linux-x86_64.AppImage" "linux-amd64.deb" "linux-x86_64.flatpak"; do
                  sed -i.bak '/<!-- BETA_DOWNLOADS -->/,/<!-- BETA_DOWNLOADS_END -->/{s|Auto-Claude-[0-9.a-z-]*-'"$SUFFIX"'](https://github.com/AndyMik90/Auto-Claude/releases/download/v[^/]*/Auto-Claude-[^)]*-'"$SUFFIX"')|Auto-Claude-'"$VERSION"'-'"$SUFFIX"'](https://github.com/AndyMik90/Auto-Claude/releases/download/v'"$VERSION"'/Auto-Claude-'"$VERSION"'-'"$SUFFIX"')|g}' README.md
                done
              else
                # STABLE: Update stable sections and top badge
                echo "  Detected STABLE version: $VERSION"

                # Update top version badge (blue)
                sed -i.bak '/<!-- TOP_VERSION_BADGE -->/,/<!-- TOP_VERSION_BADGE_END -->/s/version-[0-9]*\.[0-9]*\.[0-9]*\(--[a-z]*\.[0-9]*\)*-blue/version-'"$ESCAPED_VERSION"'-blue/g' README.md
                sed -i.bak '/<!-- TOP_VERSION_BADGE -->/,/<!-- TOP_VERSION_BADGE_END -->/s|releases/tag/v[0-9.a-z-]*)|releases/tag/v'"$VERSION"')|g' README.md

                # Update stable version badge (blue)
                sed -i.bak '/<!-- STABLE_VERSION_BADGE -->/,/<!-- STABLE_VERSION_BADGE_END -->/s/stable-[0-9]*\.[0-9]*\.[0-9]*\(--[a-z]*\.[0-9]*\)*-blue/stable-'"$ESCAPED_VERSION"'-blue/g' README.md
                sed -i.bak '/<!-- STABLE_VERSION_BADGE -->/,/<!-- STABLE_VERSION_BADGE_END -->/s|releases/tag/v[0-9.a-z-]*)|releases/tag/v'"$VERSION"')|g' README.md

                # Update stable download links (within STABLE_DOWNLOADS section only)
                for SUFFIX in "win32-x64.exe" "darwin-arm64.dmg" "darwin-x64.dmg" "linux-x86_64.AppImage" "linux-amd64.deb"; do
                  sed -i.bak '/<!-- STABLE_DOWNLOADS -->/,/<!-- STABLE_DOWNLOADS_END -->/{s|Auto-Claude-[0-9.a-z-]*-'"$SUFFIX"'](https://github.com/AndyMik90/Auto-Claude/releases/download/v[^/]*/Auto-Claude-[^)]*-'"$SUFFIX"')|Auto-Claude-'"$VERSION"'-'"$SUFFIX"'](https://github.com/AndyMik90/Auto-Claude/releases/download/v'"$VERSION"'/Auto-Claude-'"$VERSION"'-'"$SUFFIX"')|g}' README.md
                done
              fi
              rm -f README.md.bak

              # Stage changes
              git add apps/desktop/package.json README.md 2>/dev/null || true
            fi
        language: system
        files: ^package\.json$
        pass_filenames: false

  # Frontend linting (apps/desktop/) - Biome is 15-25x faster than ESLint
  # NOTE: These hooks check for worktree context to avoid npm/node_modules issues
  - repo: local
    hooks:
      - id: biome
        name: Biome (lint + format)
        entry: bash
        args:
          - -c
          - |
            # Skip in worktrees if node_modules doesn't exist (Biome not installed)
            if [ -f ".git" ] && [ ! -d "apps/desktop/node_modules" ]; then
              echo "Skipping Biome in worktree (node_modules not found)"
              exit 0
            fi
            cd apps/desktop && npx biome check --write --no-errors-on-unmatched .
        language: system
        files: ^apps/desktop/.*\.(ts|tsx|js|jsx|json)$
        pass_filenames: false

      - id: typecheck
        name: TypeScript Check
        entry: bash
        args:
          - -c
          - |
            # Skip in worktrees if node_modules doesn't exist (dependencies not installed)
            if [ -f ".git" ] && [ ! -d "apps/desktop/node_modules" ]; then
              echo "Skipping TypeScript check in worktree (node_modules not found)"
              exit 0
            fi
            cd apps/desktop && npm run typecheck
        language: system
        files: ^apps/desktop/.*\.(ts|tsx)$
        pass_filenames: false

  # General checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
        exclude: pnpm-lock\.yaml$
      - id: check-added-large-files
